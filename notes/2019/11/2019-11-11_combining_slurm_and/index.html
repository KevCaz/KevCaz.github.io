<!doctype html><html lang=en-us><head><title>KevCaz's Website</title>
<link rel=stylesheet href=https://kevcaz.github.io/css/main.min.2e0874d93dedc5b86cd2d2b471abad3b89e2cad618d46f8b7d6ef32f24918729.css media=screen><link rel=stylesheet href=../../../../css/perso.css><link rel=stylesheet href=../../../../css/family.css><meta name=author content="Kevin Cazelles"><meta name=institution content="Department of Integrated Biology, University of Guelph"><meta name=news_keywords content="[Compute Canada Advances Research Computing High Performance Computing GNU parallel Slurm]"><meta property="og:site_name" content="KevCaz's Website"><meta property="og:title" content="Combining Slurm and GNU parallel"><meta property="og:image" content="https://kevcaz.github.io/img/imgOG/kevcaz_og.png"><meta property="og:description" content="Kevin Cazelles's website"></head><body><div class=page><div class=ctn-sidebar-primary><div class=ctt-sidebar-primary><h1>KevCaz's Website</h1><div class=primary-sidebar-premenu><h2><i class='fas fa-align-center'></i> <button onclick='dropDown("p-s-menu")'> Menu</button></h2></div><div class=primary-sidebar-menu id=p-s-menu><h2><a href=../../../../><i class='fas fa-home'></i> Home</a></h2><h2><a onclick='dropDown("dropdown-research")' href=javascript:void(0)><i class='fas fa-microscope'></i> Research</a></h2><div class=dropdown id=dropdown-research><h3><a href=../../../../about_my_research/>About my research</a></h3><h3><a href=../../../../publications/>Publications</a></h3><h3><a href=../../../../software/>Software</a></h3><h3><a href=../../../../talks/>Talks & Posters</a></h3><h3><a href=../../../../teaching/>Teaching</a></h3></div><h2 id=current-dropdown><a onclick='dropDown("dropdown-blog")' href=javascript:void(0)><i class='fas fa-blog'></i> Blog</a></h2><div class=dropdown-current id=dropdown-blog><h3><a href=../../../../econotes/>EcoNotes</a></h3><h3 id=current><a href=../../../../notes/>SilicoNotes</a></h3><h3><a href=https://insileco.github.io/>inSilecoBlog</a></h3></div><h2><a onclick='dropDown("dropdown-perso")' href=javascript:void(0)><i class='fas fa-person-booth'></i> Miscelleneous</a></h2><div class=dropdown id=dropdown-perso><h3><a href=../../../../perso/books>Books</a></h3><h3><a href=../../../../perso/movies>Movies</a></h3><h3><a href=../../../../perso/opinions>Opinions</a></h3></div></div><div class=footer><hr id=hr-footer align=left><div class=social-media-banner><a href=https://github.com/KevCaz><i class='fab fab fa-github-square'></i></a>
<a href=https://stackoverflow.com/users/8038778><i class='fab fa-stack-overflow'></i></a>
<a href=https://mastodon.social/@KCazelles><i class='fab fa-mastodon'></i></a>
<a href=http://orcid.org/0000-0001-6619-9874><i class='ai ai-orcid-square'></i></a>
<a href="https://scholar.google.ca/citations?user=xzvcu7cAAAAJ%26hl"><i class='ai ai-google-scholar-square'></i></a>
<a href=https://www.researchgate.net/profile/Kevin_Cazelles><i class='ai ai-researchgate-square'></i></a>
<a href=https://kevcaz.github.io/index.xml><i class="fas fa-rss-square"></i></a></div><div class=footer-custom>Website built with <a href=https://gohugo.io/>Hugo</a>.<br><i class='fas fa-code'></i> available on <a href=https://github.com/KevCaz/KevCaz.github.io><i class='fab fa-github'></i></a>.<br>Content under <a href=https://creativecommons.org/publicdomain/zero/1.0><i class='fab fa-creative-commons'></i><i class='fab fa-creative-commons-zero'></i></a> unless otherwise specified.<br>Latest build: 01 Jul 2024 04:45 UTC</div></div></div></div><div class=ctn-main-content><div class=ctt-main-content><div class=article-meta><h1 id=title>Combining Slurm and GNU parallel</h1><h3 class=date>November 11, 2019<div class=tags><i class="fas fa-tags" aria-hidden=true></i> &nbsp;
<a href=../../../../tags/compute-canada><kbd class=item-tag>Compute Canada</kbd></a>
<a href=../../../../tags/advances-research-computing><kbd class=item-tag>Advances Research Computing</kbd></a>
<a href=../../../../tags/high-performance-computing><kbd class=item-tag>High Performance Computing</kbd></a>
<a href=../../../../tags/gnu-parallel><kbd class=item-tag>GNU parallel</kbd></a>
<a href=../../../../tags/slurm><kbd class=item-tag>Slurm</kbd></a></div></div><div class=article-main><p>Last week, I attended a &ldquo;Midi conf√©rence&rdquo; (basically a one hour training session
during lunch time) offered by Compute Canada dealing with
<a href=https://slurm.schedmd.com/quickstart.html>Slurm</a>, <a href=https://www.gnu.org/software/parallel/>GNU
Parallel</a> and how to combine them. This
was a very useful and timely presentation for me (<a href="https://docs.google.com/presentation/d/1ysIaSWa157yiZ-ocX1jkAys1NkGgwolArSwCgAYCUPQ/edit?ts=5dc04169#slide=id.g65b5e056e3_0_5">&#x1f1eb;&#x1f1f7; slides available online
&#x1f517;</a>)
as I&rsquo;ve just got started with Slurm (see my <a href=../../../../notes/computesci/graham>previous notes on the
topic</a>) and was eager to learn more.</p><p>Earlier today, I found an opportunity to put in practice what I&rsquo;ve learned last
week. Indeed I needed to download hundreds of shapefiles (2 different kind of
shapefiles at 2 different for almost 120 years), extract values from them before
deleting them. To do so, I wrote the following bash script to distribute the
simulations on 5 nodes and use 4 CPUs per node:</p><div class=highlight><div style=color:#575279;background-color:#faf4ed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#575279;background-color:#faf4ed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#575279;background-color:#faf4ed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#9893a5>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#9893a5></span><span style=color:#9893a5>#SBATCH --time=6:00:00</span>
</span></span><span style=display:flex><span><span style=color:#9893a5>#SBATCH --nodes=5</span>
</span></span><span style=display:flex><span><span style=color:#9893a5>#SBATCH --array=1-5</span>
</span></span><span style=display:flex><span><span style=color:#9893a5>#SBATCH --ntasks-per-node=1</span>
</span></span><span style=display:flex><span><span style=color:#9893a5>#SBATCH --cpus-per-task=4</span>
</span></span><span style=display:flex><span><span style=color:#9893a5>#SBATCH --mem-per-cpu=4G</span>
</span></span><span style=display:flex><span><span style=color:#9893a5>#SBATCH --account=def-ksmccann</span>
</span></span><span style=display:flex><span><span style=color:#9893a5>#SBATCH --mail-user=kcazelle@uoguelph.ca</span>
</span></span><span style=display:flex><span><span style=color:#9893a5>#SBATCH --mail-type=FAIL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#9893a5># working directory is where the task is submitted</span>
</span></span><span style=display:flex><span><span style=color:#d7827e>cd</span> <span style=color:#d7827e>$SLURM_SUBMIT_DIR</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>parallel --delay <span style=color:#ea9d34>1</span> Rscript ./scr_extract.R <span style=color:#d7827e>$SLURM_ARRAY_TASK_ID</span> <span style=color:#797593>{</span>1<span style=color:#797593>}</span> <span style=color:#797593>{</span>2<span style=color:#797593>}</span> ::: <span style=color:#797593>{</span>1..2<span style=color:#797593>}</span> ::: <span style=color:#797593>{</span>1..2<span style=color:#797593>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>#SBATCH</code> instructions do the following:</p><ul><li><code>#SBATCH --time=6:00:00</code>: allocate 6 hours for the job;</li><li><code>#SBATCH --nodes=5</code>: allocate 5 nodes;</li><li><code>#SBATCH --array=1-5</code>: generate 5 tasks with 1, 2, 3, 4 and 5 as identifiers (represented by <code>$SLURM_ARRAY_TASK_ID</code>);</li><li><code>#SBATCH --ntasks-per-node=1</code>: only one task per node;</li><li><code>#SBATCH --cpus-per-task=4</code>: allocate 4 CPUs per task;</li><li><code>#SBATCH --mem-per-cpu=4G</code>: allocate 4Gb of RAM per CPU.</li></ul><p>and in the main command:</p><div class=highlight><div style=color:#575279;background-color:#faf4ed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#575279;background-color:#faf4ed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#575279;background-color:#faf4ed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ parallel --delay <span style=color:#ea9d34>1</span> Rscript ./scr_extract.R <span style=color:#d7827e>$SLURM_ARRAY_TASK_ID</span> <span style=color:#797593>{</span>1<span style=color:#797593>}</span> <span style=color:#797593>{</span>2<span style=color:#797593>}</span> ::: <span style=color:#797593>{</span>1..2<span style=color:#797593>}</span> ::: <span style=color:#797593>{</span>1..2<span style=color:#797593>}</span>
</span></span></code></pre></td></tr></table></div></div><p>the Rscript <code>scr_extract.R</code> takes 3 arguments:</p><ul><li>the first one are the task identifiers (<code>$SLURM_ARRAY_TASK_ID</code>) managed by
Slurm and, given the setup I described above, this argument varies with the
node!</li><li>the second and third arguments are handled by GNU parallel so that, on each node, it generates the same four combinations (i.e. (1,1), (1,2), (2,1), (2,2)), each of which is run by one of the four CPUs allocated per node.</li></ul><p>&#9888;&#xfe0f; Note that if <code>SBATCH --ntasks-per-node=1</code> is used without specifying
the number of CPUs per task, only one CPU will be allocated, making <code>parallel</code>
useless! That is why I added <code>#SBATCH --cpus-per-task=4</code> to have 4 instead of 1.</p><p>So, this set up allowed me to</p><ol><li>use five different nodes and to have a unique ID for those (<code>$SLURM_ARRAY_TASK_ID</code>);</li><li>do the same parallelization on each of them (with a different input).</li></ol><p>It turned out the only good reason for doing that was to apply what I&rsquo;ve learned
a few days ago &#x1f606;&#x1f606;&#x1f606;!</p></div></div><div class=footer2><hr id=hr-footer align=left><div class=social-media-banner><a href=https://github.com/KevCaz><i class='fab fab fa-github-square'></i></a>
<a href=https://stackoverflow.com/users/8038778><i class='fab fa-stack-overflow'></i></a>
<a href=https://mastodon.social/@KCazelles><i class='fab fa-mastodon'></i></a>
<a href=http://orcid.org/0000-0001-6619-9874><i class='ai ai-orcid-square'></i></a>
<a href="https://scholar.google.ca/citations?user=xzvcu7cAAAAJ%26hl"><i class='ai ai-google-scholar-square'></i></a>
<a href=https://www.researchgate.net/profile/Kevin_Cazelles><i class='ai ai-researchgate-square'></i></a>
<a href=https://kevcaz.github.io/index.xml><i class="fas fa-rss-square"></i></a></div><div class=footer-custom>Website built with <a href=https://gohugo.io/>Hugo</a>.<br><i class='fas fa-code'></i> available on <a href=https://github.com/KevCaz/KevCaz.github.io><i class='fab fa-github'></i></a>.<br>Content under <a href=https://creativecommons.org/publicdomain/zero/1.0><i class='fab fa-creative-commons'></i><i class='fab fa-creative-commons-zero'></i></a> unless otherwise specified.<br>Latest build: 01 Jul 2024 04:45 UTC</div></div></div><div class=ctn-sidebar-secondary><div class=ctt-sidebar-secondary><h1><a href=#><i class='far fas fa-chevron-up'></i></a></h1><script src=../../../../js/sidebar-secondary.js></script><h1><a onclick=scrollToBottom()><i class='far fas fa-chevron-down'></i></a></h1></div></div></div><script src=../../../../js/sidebar-primary-dropdown.js></script><script>scrollingElement=document.scrollingElement||document.body;function scrollToBottom(){scrollingElement.scrollTop=scrollingElement.scrollHeight}</script></body></html>